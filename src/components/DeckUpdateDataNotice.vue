<template>
	<div class="wrap">
		<aside
			v-if="deckDataOutdated"
			class="outdated-deck-data-notice"
		>
			<p>⚠ This deck is using an outdated set of card data. Update it to get enhanced app features!</p>
			<p
				v-if="!updatingDeckData"
				class="update-button-cont"
			>
				<button @click="updateData()">Update</button>
			</p>
			<p
				v-else
				class="update-button-cont loading-indicator"
			>
				<em>Updating now&hellip;</em>
			</p>
		</aside>
	</div>
</template>

<script>
export default {
	data () {
		return {
			updatingDeckData: false
		}
	},
	props: {
		deck: Object
	},
	computed: {
		deckDataOutdated () {
			return this.deck.dataVersion < 2
		}
	},
	created () {
		this.determineDeckDataVersion()
	},
	methods: {
		/**
		 * Check whether any `card` object includes the `keywords` key (even if it's set to no value). Card objects generated by older versions of the app are missing the `keywords` key, as well as `power` and `toughness` keys simultaneously, and so certain parts of the app won't be able to work properly.
		 */
		determineDeckDataVersion () {
			const deck = this.deck

			if (!deck.dataVersion) {
				const haveKeywordsObjectKey = () => {
					for (let i = 0; i < deck.cards.length; i++) {
						if (!deck.cards[i].keywords) {
							return 1
						}
					}
					return 2

					// No need to bother checking the sideboard's cards for the `keywords` object key, because the sideboard was released after `keywords`.
				}

				deck.dataVersion = haveKeywordsObjectKey()

				this.$nextTick(() => {
					this.$store.commit('setDecks', this.$store.state.decks)
				})
			}
		},
		updateData () {
			const updateCardGroupData = (cardGroup) => {
				const cards = cardGroup.cards

				if (cards.length > 150) {
					alert('⚠ Sorry, this deck’s data cannot be updated because it has too many cards.')
				} else {
					this.updatingDeckData = true

					let cardsUpdated = 0

					for (let i = 0; i < cards.length; i++) {
						setTimeout(() => {
							this.requestScryfallData(
								cards[i].name, false, cards[i], callback()
							)

							if (cardsUpdated === cards.length) {
								if (this.$store.state.showSideboard) {
									setTimeout(() => {
										this.$router.go(0) // Reload the page
									}, 250) // Add a little extra time to let the user's CPU work with the updated card values before reloading the page.
								} else {
									// The main group's cards are done, now do the sideboard's.
									this.$store.commit('setShowSideboard', true)

									updateCardGroupData(this.deck.sideboard)
								}
							}
						}, 100 * i)
					}
					function callback () {
						cardsUpdated++
					}
				}
			}

			updateCardGroupData(this.deck)
		}
	}
}
</script>

<style lang="scss">
	@import '@/sass/page-deck.scss';
</style>
